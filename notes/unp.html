<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>UNIXç½‘ç»œç¼–ç¨‹</title>
<!-- 2013-12-15 ÖÜÈÕ 19:49 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="your name" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="/static/css/main.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="http://harrifeng.github.io/sitemap.html"> UP </a>
 |
 <a accesskey="H" href="http://harrifeng.github.io/index.html"> HOME </a>
</div><div id="preamble" class="status">

         <div id="header">
            <div id="header-top">
                <div id="blog-title">Harrifeng's Path</div>
                <div id="blog-sub-title"></div>
            </div>
            <div id="nav">
                <ul>
                    <li><a href="/">é¦–é¡µ</a></li>
                    <li><a href="/notes.html">è¯»ä¹¦ç¬”è®°</a></li>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/atom.xml">RSS</a></li>
                    <li>
                    </li>
                </ul>
            </div>
         </div>
</div>
<div id="content">
<h1 class="title">UNIXç½‘ç»œç¼–ç¨‹</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Chapter 1: Introduction</a>
<ul>
<li><a href="#sec-1-1">Introduction</a></li>
<li><a href="#sec-1-2">A Simple Daytime Client</a></li>
<li><a href="#sec-1-3">Protocol Independence</a></li>
<li><a href="#sec-1-4">Error Handling: Wrapper Function</a></li>
<li><a href="#sec-1-5">A Simple Daytime Server</a></li>
</ul>
</li>
<li><a href="#sec-2">Chapter 2: The Transport Layer: TCP, UPD, and SCTP</a>
<ul>
<li><a href="#sec-2-1">Introduction</a></li>
<li><a href="#sec-2-2">The Big Picture</a></li>
<li><a href="#sec-2-3">User Datagram Protocol (UDP)</a></li>
<li><a href="#sec-2-4">Transmission Control Protocol (TCP)</a></li>
<li><a href="#sec-2-5">Stream Control Transmission Protocol (SCTP)</a></li>
<li><a href="#sec-2-6">TCP Connection Establishment and Termination</a>
<ul>
<li><a href="#sec-2-6-1">TCP Options</a></li>
<li><a href="#sec-2-6-2">TCP Connection Termination</a></li>
<li><a href="#sec-2-6-3">TCP State Transitiion Diagram</a></li>
<li><a href="#sec-2-6-4">Watcing the Packets</a></li>
</ul>
</li>
<li><a href="#sec-2-7">TIME_WAIT State</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Chapter 1: Introduction</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Introduction</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Web serveræ˜¯é•¿æœŸè¿è¡Œçš„ç¨‹åº, è€ŒWeb client(æ¯”å¦‚æµè§ˆå™¨)å°±æ˜¯å‘å‡ºè¯·æ±‚çš„ç¨‹åº.
</li>
<li>ä¸€èˆ¬æ¥è¯´,éƒ½æ˜¯clientç«¯å‘é€è¯·æ±‚, ä¹Ÿæœ‰å¼‚æ­¥å›è°ƒ(asynchronous callback)é€šä¿¡,æ˜¯
serverç«¯å…ˆå‘èµ·çš„.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">A Simple Daytime Client</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„è¯·æ±‚æ—¶é—´å’Œæ—¥æœŸçš„client
<div class="org-src-container">

<pre class="src src-c"><span style="color: #505C63;">/*************************/</span>
<span style="color: #505C63;">/* </span><span style="color: #505C63;">intro/daytimectpcli.c </span><span style="color: #505C63;">*/</span>
<span style="color: #505C63;">/*************************/</span>

include <span style="color: #F8F8F0;">"unp.h"</span>

<span style="color: #999999;">int</span> main(<span style="color: #999999;">int</span> <span style="color: #FD971F;">argc</span>, <span style="color: #999999;">char</span> *<span style="color: #FD971F;">argv</span>[])
{
    <span style="color: #999999;">int</span>                 <span style="color: #FD971F;">sockfd</span>;
    <span style="color: #999999;">int</span>                 <span style="color: #FD971F;">n</span>;
    <span style="color: #999999;">char</span>                <span style="color: #FD971F;">recvline</span>[MAXLINE + 1];
    <span style="color: #A7DBD8;">struct</span> <span style="color: #999999;">sockadr_in</span>   <span style="color: #FD971F;">servaddr</span>;

    <span style="color: #A7DBD8;">if</span> (argc != 2) {
        err_quit(<span style="color: #F8F8F0;">"usage: a.out &lt;IPaddress&gt;"</span>);
    }

    <span style="color: #A7DBD8;">if</span> ((sockfd = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) {
        err_sys(<span style="color: #F8F8F0;">"socket error"</span>);
    }

    bzero(&amp;servaddr, <span style="color: #A7DBD8;">sizeof</span>(servaddr));
    servaddr.sin_family = AF_INET;
    servaddr.sin_port = htons(13);    <span style="color: #505C63;">/* </span><span style="color: #505C63;">daytime server port </span><span style="color: #505C63;">*/</span>
    <span style="color: #A7DBD8;">if</span> (inet_pton(AF_INET, argv[1], &amp;servaddr.sin_addr) &lt;= 0) {
        err_quit(<span style="color: #F8F8F0;">"inet_pton error for %s"</span>, argv[1]);
    }
    <span style="color: #505C63;">/**********************************************/</span>
    <span style="color: #505C63;">/* </span><span style="color: #505C63;">in unp.h, #define SA to be struct sockaddr </span><span style="color: #505C63;">*/</span>
    <span style="color: #505C63;">/**********************************************/</span>
    <span style="color: #A7DBD8;">if</span> (connect(sockfd, (<span style="color: #999999;">SA</span> *) &amp;servaddr, <span style="color: #A7DBD8;">sizeof</span>(servaddr)) &lt; 0) {
        err_sys(<span style="color: #F8F8F0;">"connect error"</span>);
    }

    <span style="color: #A7DBD8;">while</span> ((n = read(sockfd, recvline, MAXLINE)) &gt; 0) {
        recvline[n] = 0;
        <span style="color: #A7DBD8;">if</span> (fputs(recvline, stdout) == EOF) {
            err_sys(<span style="color: #F8F8F0;">"fputs error"</span>);
        }
    }
    <span style="color: #A7DBD8;">if</span> (n &lt; 0) {
        err_sys(<span style="color: #F8F8F0;">"read error"</span>);
    }
    <span style="color: #A7DBD8;">return</span> 0;
}
</pre>
</div>
</li>
<li>ä½¿ç”¨æ–¹æ³•:
<div class="org-src-container">

<pre class="src src-sh">~/test/unpbook/intro$ ./daytimetcpcli 127.0.0.1
Wed Nov 20 14:33:08 2013
</pre>
</div>
</li>
<li>socket å‡½æ•°åˆ›å»ºä¸€ä¸ªsocket, å…¶è¿”å›å‚æ•°ä¸ºsockfd, å…¶å‚æ•°ä¸ºAF_INETè¡¨ç¤ºä¸ºIPv4, 
SOCK_STREAMè¡¨ç¤ºä¸ºTCP socket
</li>
<li>åé¢æˆ‘ä»¬å°±åˆ›å»ºä¸€ä¸ªsocketçš„æ•°æ®ç»“æ„(ç±»å‹ä¸ºstruct sockadr_in), æˆ‘ä»¬ä½¿ç”¨bzero
è¿™ä¸ªå‡½æ•°æŠŠæ•´ä¸ªæ•°æ®ç»“æ„å…¨éƒ¨æ¸…é›¶.
</li>
<li>servaddr(ç±»å‹ä¸ºstruct sockadr_in)æ˜¯æ•´ä¸ªå‡½æ•°çš„é‡ç‚¹, åœ¨ç”¨bzeroæ¸…é›¶ä»¥å,åé¢
æ˜¯ç»™ä»–çš„æ¯ä¸ªéƒ¨åˆ†èµ‹å€¼çš„è¿‡ç¨‹ 
<ol class="org-ol">
<li>sin_family
</li>
<li>sin_port
</li>
<li>ä½¿ç”¨inet_ptonå‡½æ•°æŠŠä¸€ä¸ªAF_INETç±»å‹ipåœ°å€, è½¬æ¢æˆåˆé€‚çš„æ ¼å¼,ç„¶åèµ‹å€¼ç»™sin_addr
</li>
</ol>
</li>
<li>connectå‡½æ•°é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°æ¥çŸ¥é“è¦è¿æ¥å“ªä¸ªåœ°å€(ç¬¬ä¸‰ä¸ªé•¿åº¦èµ·è¾…åŠ©ä½œç”¨),ç„¶åæŠŠserver
è¿”å›çš„ç»“æœéƒ½è¿”å›ç»™ç¬¬ä¸€ä¸ªå‚æ•°
</li>
<li>é€šè¿‡readå‡½æ•°æ¥è¯»å–connectå¸¦æ¥çš„ç»“æœ. daytime serverçš„è¿”å›å€¼éƒ½æ˜¯26ä¸ªbytes,
ä½†æ˜¯æ ¹æ®ç½‘ç»œæƒ…å†µçš„ä¸åŒ,è¿™äº›byteså¯èƒ½é€šè¿‡ä¸åŒæ•°é‡çš„TCP segmentè¿”å›., æ‰€ä»¥æˆ‘ä»¬å¾—
ç”¨whileæ¥æ¥æ”¶.ç„¶åæŠŠrecvlineæœ€åä¸€ä¸ªèµ‹å€¼æˆ0 (å› ä¸ºTCPé‡Œé¢çš„å­—ç¬¦ä¸²ä¸æ˜¯cè¯­è¨€å­—ç¬¦ä¸²,
æ²¡æœ‰ä»¥NULLç»“å°¾)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">Protocol Independence</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨çš„æ˜¯IPV4çš„IPåœ°å€, å¦‚æœä½¿ç”¨IPV6çš„IPåœ°å€,é‚£ä¹ˆå°±ç”¨sockaddr_in6
æ›¿æ¢ä¸Šé¢ä¾‹å­çš„sockaddr_in
</li>
<li>åŒæ—¶AF_INET ==&gt; AF_INET6
</li>
<li>sin_family ==&gt; sin6_port
</li>
<li>sin_port ==&gt; sin6_port
</li>
<li>sin_addr ==&gt; sin6_addr
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">Error Handling: Wrapper Function</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>è€æ˜¯æµ‹è¯•è¿”å›å€¼æ˜¯ä¸æ˜¯0,å¤ªéº»çƒ¦äº†,æ‰€ä»¥è®¾è®¡äº†wrapper function,ç‰¹ç‚¹æ˜¯å¦å¤–è®¾è®¡ä¸€äº›å‡½æ•°
é¦–å­—æ¯å¤§å†™,é‡Œé¢æµ‹è¯•è¿”å›å€¼æ˜¯ä¸æ˜¯0, æˆ‘ä»¬ä»¥socketå‡½æ•°ä¸ºä¾‹.
<div class="org-src-container">

<pre class="src src-c">sockfd = socket(AF_INET, SOCK_STREAM, 0);
<span style="color: #999999;">int</span> <span style="color: #AEE239;">Socket</span>(<span style="color: #999999;">int</span> <span style="color: #FD971F;">family</span>, <span style="color: #999999;">int</span> <span style="color: #FD971F;">type</span>, <span style="color: #999999;">int</span> <span style="color: #FD971F;">protocol</span>) {
    <span style="color: #999999;">int</span> <span style="color: #FD971F;">n</span>;
    <span style="color: #A7DBD8;">if</span> ((n = socket(family, type, protocol)) &lt; 0) {
        err_sys(<span style="color: #F8F8F0;">"socket error"</span>);
    }
    <span style="color: #A7DBD8;">return</span> (n);
}
</pre>
</div>
</li>
<li>åœ¨Unixå‡½æ•°é‡Œé¢å¦‚æœå‡ºç°äº†é”™è¯¯, é‚£ä¹ˆä¸€ä¸ªå…¨å±€å˜é‡errnoå°±ä¼šè¢«è®¾ç½®æˆä¸€ä¸ªæ­£æ•°, åŒæ—¶å‡½æ•°è¿”å›
è´Ÿæ•°-1. æˆ‘ä»¬çš„err_syså‡½æ•°å°±æ˜¯é€šè¿‡æŸ¥çœ‹errno,å¹¶ä¸”æ‰“å°erroré”™è¯¯
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">A Simple Daytime Server</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>æˆ‘ä»¬å†æ¥çœ‹çœ‹serverç«¯å¦‚ä½•å†™:
<div class="org-src-container">

<pre class="src src-c"><span style="color: #505C63;">/**************************/</span>
<span style="color: #505C63;">/* </span><span style="color: #505C63;">intro/daytimetcpsrv.c  </span><span style="color: #505C63;">*/</span>
<span style="color: #505C63;">/**************************/</span>
<span style="color: #F38630;">#include</span> <span style="color: #F8F8F0;">"unp.h"</span>
<span style="color: #F38630;">#include</span> <span style="color: #F8F8F0;">&lt;time.h&gt;</span>

<span style="color: #999999;">int</span> <span style="color: #AEE239;">main</span>(<span style="color: #999999;">int</span> <span style="color: #FD971F;">argc</span>, <span style="color: #999999;">char</span> *<span style="color: #FD971F;">argv</span>[])
{
    <span style="color: #999999;">int</span>       <span style="color: #FD971F;">listenfd</span>;
    <span style="color: #999999;">int</span>       <span style="color: #FD971F;">connfd</span>;
    <span style="color: #999999;">char</span>      <span style="color: #FD971F;">buff</span>[MAXLINE];
    <span style="color: #999999;">time_t</span>    <span style="color: #FD971F;">ticks</span>;

    listenfd = Socket(AF_INET, SOCK_STREAM, 0);

    bzeros(&amp;servaddr, <span style="color: #A7DBD8;">sizeof</span>(servaddr));
    servaddr.sin_family = AF_INET;
    servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
    servaddr.sin_port = htons(13); <span style="color: #505C63;">/* </span><span style="color: #505C63;">daytime server port </span><span style="color: #505C63;">*/</span>

    Bind(listenfd, (<span style="color: #999999;">SA</span>*) &amp;servaddr, siezeof(servaddr));
    <span style="color: #505C63;">/**********************************************************/</span>
    <span style="color: #505C63;">/* </span><span style="color: #505C63;">LISTENQ is from unp.h, it specifies the maximum number </span><span style="color: #505C63;">*/</span>
    <span style="color: #505C63;">/* </span><span style="color: #505C63;">of client connections that kernel will queue for this  </span><span style="color: #505C63;">*/</span>
    <span style="color: #505C63;">/* </span><span style="color: #505C63;">listening descriptor                                   </span><span style="color: #505C63;">*/</span>
    <span style="color: #505C63;">/**********************************************************/</span>
    Listen(listenfd, LISTENQ);

    <span style="color: #A7DBD8;">for</span> ( ; ;) {
        connfd = Accept(listenfd, (<span style="color: #999999;">SA</span>*)<span style="color: #AEE239;">NULL</span>, <span style="color: #AEE239;">NULL</span>);

        ticks = time(<span style="color: #AEE239;">NULL</span>);
        snprintf(buff, <span style="color: #A7DBD8;">sizeof</span>(buff), <span style="color: #F8F8F0;">"%.24s\n\n"</span>, ctime(&amp;ticks));
        Write(connfd, buff, strlen(buff));
        Close(connfd);
    }
    <span style="color: #A7DBD8;">return</span> 0;
}
</pre>
</div>
</li>
<li>Socketå‡½æ•°é¦–å…ˆå»ºç«‹ä¸€ä¸ªsocket
</li>
<li>bzerosåˆå§‹åŒ–socketçš„æ•°æ®ç»“æ„servaddr, ç„¶åç»™å„éƒ¨åˆ†èµ‹å€¼, å’Œclientç¨‹åºä¸€æ ·, 
sin_familyå’Œsin_portè¢«èµ‹äº†AF_INETå’Œhtons(13)
</li>
<li>è€Œsin_addr.s_addråœ¨clientæ˜¯ä»…ä»…èµ‹å€¼äº†ç›®æ ‡serverçš„å€¼(é€šè¿‡a.outçš„ç¬¬äºŒä¸ªå‚æ•°å¾—åˆ°),
è¿™é‡Œå´èµ‹å€¼INADDR_ANY, è¿™æ˜¯ä¸ºäº†è®©serveræ¥å—æ¥è‡ªæœ¬æœºä»»æ„ä¸€ä¸ªç½‘å¡çš„æ•°æ®(å› ä¸ºä¸€ä¸ªhost
å¯èƒ½æœ‰å¤šä¸ªç½‘å¡)
</li>
<li>clientçš„socketæ•°æ®ç»“æ„èµ‹å€¼å®Œä¹‹å,å°±æ˜¯connect,ç„¶åread, serverçš„æ“ä½œè¦å¤šä¸€ç‚¹
</li>
<li>serverç«¯å’Œclientçš„connectç›¸ä¼¼çš„å‘½ä»¤æ˜¯bind: éƒ½æ˜¯æŠŠsocketå’Œsocketæ•°æ®ç»“æ„è”ç³»
èµ·æ¥
</li>
<li>bindä¹‹å,å°±ç”¨listenå‡½æ•°,å°±æŠŠä¸€ä¸ªsocketå˜æˆäº†listening socket
</li>
<li>TCPä½¿ç”¨çš„æ˜¯ä¸‰æ¬¡æ¡æ‰‹åè®®æ¥å»ºç«‹è¿æ¥, acceptå‡½æ•°è¿”å›çš„æ—¶å€™,å°±æ˜¯ä¸‰æ¬¡æ¡æ‰‹æˆåŠŸå®Œæˆçš„æ—¶å€™,
acceptå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ–°çš„descriptor,å«åšconnected descriptor. serverä¼šåŒæ—¶
æ¥å—å¤šä¸ªclientçš„è¯·æ±‚,serverä¼šç»™æ¯ä¸ªclientä¸€ä¸ªconnected descriptor
</li>
<li>æ—¶é—´ç»è¿‡å­—ç¬¦ä¸²å¤„ç†ä»¥å,é€šè¿‡Writeå‘é€ç»™connfd
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Chapter 2: The Transport Layer: TCP, UPD, and SCTP</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Introduction</h3>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">The Big Picture</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>tcpdump: æ˜¯ä¸€ä¸ªç›´æ¥ä¸datalinkæ²Ÿé€šçš„å·¥å…·, Linuxä¸‹é¢å…¶å®è¿˜æœ‰ä¸€ç§socketä¸
datalinkç»ƒä¹ çš„socket,å«åšSOCK_PACKET
</li>
<li>traceroute: ç”¨äº†ä¸¤ä¸ªsockets: ä¸€ä¸ªæ˜¯IP,å¦ä¸€ä¸ªæ˜¯ICMP
</li>
<li>SCTP: æ˜¯ä¸€ä¸ªæ–°çš„ç½‘ç»œåè®®, å¯ä»¥ç”¨IPv4æˆ–è€…IPv6
</li>
<li>ICMP: å¤„ç†é”™è¯¯å’Œæ§åˆ¶ä¿¡æ¯
</li>
<li>IGMP: å¤„ç†multicastingçš„,å·²ç»ä¸æ€ä¹ˆç”¨äº†
</li>
<li>ARP: IPåœ°å€&#x2013;&gt;MACåœ°å€
</li>
<li>RARP: MACåœ°å€&#x2013;&gt;IPåœ°å€
</li>
<li>ICMPv6: æ˜¯IPv6é‡Œé¢å…¨é¢æ›¿ä»£ICMPv4, IGMP, ä»¥åŠARP
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">User Datagram Protocol (UDP)</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>UDPæ˜¯ç½‘ç»œå±‚åè®®, ä¸èƒ½ä¿è¯ä¼ è¾“çš„æˆåŠŸ,å› ä¸ºå®ƒæ²¡æœ‰ä¿è¯ä¼ è¾“å¯é æ€§çš„æ–¹æ³•, éœ€è¦
åº”ç”¨å±‚æ¥ä¿è¯
</li>
<li>TCPæ˜¯ä¸€ä¸ªbyte-streamçš„åè®®,æ²¡æœ‰ä»»ä½•è¾¹ç•Œçš„æ¦‚å¿µ, ä½†æ˜¯UDPæœ‰,æ¯ä¸ªUDPéƒ½æœ‰é•¿åº¦,
éƒ½ä¼šæœ€åä¼ è¾“ç»™å¯¹æ–¹
</li>
<li>UDPæ¯”è¾ƒè‡ªç”±,ä¸è¦ç»´æŠ¤relation, å®ƒå¯ä»¥å‘é€ä¸€ä¸ªsocketç»™serverA, ç„¶åé©¬ä¸Šå‘é€
åŒä¸€ä¸ªsocketç»™serverB.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4">Transmission Control Protocol (TCP)</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>TCPæä¾›äº†ä¼ è¾“çš„å¯é æ€§: å¹¶ä¸æ˜¯è¯´ç”¨TCPä¸€å®šèƒ½æŠŠæ•°æ®ä¼ è¾“ç»™å¯¹æ–¹, è€Œæ˜¯å¦‚æœèƒ½ä¼ è¾“æ•°æ®
å°±ä¼ è¾“,å¦‚æœä¼ è¾“ä¸æˆåŠŸ,ä¹Ÿèƒ½æŠ¥é”™.
</li>
<li>TCPè¿˜æœ‰è‡ªå·±çš„ç®—æ³•æ¥è®¡ç®—RTT(round-trip time) : ä¹Ÿå°±æ˜¯clientå’Œserverä¹‹é—´çš„
ä¼ è¾“ä¸€æ¬¡çš„æ—¶é—´.
</li>
<li>RTTè¿™ä¸ªæ—¶é—´æ˜¯æ ¹æ®å½“å‰ç½‘ç»œçŠ¶å†µå’Œè·ç¦»è€Œè®¾å®šçš„, å¹¶ä¸”æ˜¯ä¸åœè®¡ç®—çš„
</li>
<li>TCPè¿˜ä¼šè®°å½•åºåˆ—, å‘é€çš„æ—¶å€™å¯èƒ½åºåˆ—æ˜¯123, åˆ°è¾¾çš„æ—¶å€™å°±ä¹±äº†.æ¥æ”¶æ–¹çš„TCP ä¼šæŠŠæ‰€æœ‰
çš„TCP segmenté‡æ–°æ’åˆ—(å¦‚æœæœ‰æ”¶åˆ°é‡ä¼ çš„segment,ä¹Ÿä¼šæ™ºèƒ½ä¸¢å¼ƒ).
</li>
<li>TCPè¿˜æä¾›æµé‡æ§åˆ¶: TCPä¸€ç›´å‘Šè¯‰å¯¹æ–¹è‡ªå·±èƒ½å¤Ÿæ¥å—å¤šå°‘çš„æ•°æ®,è¿™å«advertised window.
</li>
<li>è¿™ä¸ªwindowså°±æ˜¯æ¥æ”¶æ–¹èƒ½å¤Ÿæä¾›çš„æœ€å¤§çš„å†…å­˜ç©ºé—´.è¿™ä¸ªæ•°å­—æ˜¯ä¸åœæ”¹å˜çš„,åˆšæ¥å—æ¥è‚¯å®š
æ•°å­—å˜å°, å¤„ç†ä¸€ä¼šè‚¯å®šæ•°å­—å˜å¤§. çª—å£æ•°å­—ä¹Ÿæ˜¯å¯ä»¥å˜æˆ0çš„,å¦‚æœæ¥æ”¶æ–¹å¤„ç†ä¸è¿‡æ¥,å½“ç„¶
è¦åœæ­¢ä½ çš„ä¼ è¾“
</li>
<li>TCPæ˜¯å…¨åŒå·¥çš„,ä¹Ÿå°±æ˜¯è¯´,ä¼ è¾“æ˜¯åŒæ–¹å‘çš„,å¹¶ä¸æ˜¯å«serverå°±ä¸æ¥å—,å«clientå°±ä¸å‘é€.
å½“ç„¶æŸä¸ªæ–¹å‘çš„ä¼ è¾“åœæ­¢ä¹Ÿæ˜¯å¯ä»¥è‡ªç”±å†³å®šçš„.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5">Stream Control Transmission Protocol (SCTP)</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>SCTPæä¾›äº†ä¸€ç§clientå’Œserverä¹‹é—´çš„association, ä¹‹æ‰€ä»¥å«associationè€Œä¸æ˜¯å«
connectionæ˜¯å› ä¸º:å› ä¸ºconnectionæ˜¯ä¸¤ä¸ªIPä¹‹é—´çš„è”ç³»,è€ŒSCTPæ˜¯ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´çš„è”ç³»
ä¸ä»…ä»…æ˜¯ä¸¤ä¸ªIP
</li>
<li>åœ¨æ¶ˆæ¯ä¼ é€’ä¸Šé¢,SCTPæ›´åƒUDP,å®ƒæŠŠæ¯ä¸ªè®°å½•çš„é•¿åº¦éƒ½ä¼ è¾“ç»™äº†å¯¹æ–¹
</li>
<li>SCTPæ”¯æŒä¸¤ä¸ªç«¯ä¹‹é—´çš„å¤šä¸ªstream, å…¶ä¸­ä¸€ä¸ªstreamå¦‚æœä¸¢å¤±äº†ä¸€ä¸ªæ•°æ®çš„è¯,ä¸ä¼šå½±å“
å…¶ä»–stream. è¿™ä¸ªå’ŒTCPä¸ä¸€æ ·,TCPä¸€ä¸ªbyteä¸¢å¤±å°±è¦å½±å“ä»¥åçš„ä¼ è¾“(å› ä¸ºè¦é‡æ–°æ’åº)
</li>
<li>SCTPç‰¹æ€§è¿˜æœ‰:å•ä¸ªSCTPç«¯ç‚¹æ”¯æŒå¤šä¸ªIPåœ°å€. TCPä¹Ÿå¯ä»¥åœ¨å…¶ä»–è·¯ç”±åè®®çš„æ”¯æŒä¸‹è·å¾—
è¿™ç§ç‰¹æ€§
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6">TCP Connection Establishment and Termination</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>TCPå»ºç«‹è¿æ¥çš„æ—¶å€™é€šå¸¸æœ‰å¦‚ä¸‹çš„è¿‡ç¨‹:
<ol class="org-ol">
<li>æœåŠ¡å™¨å¿…é¡»é¦–å…ˆå‡†å¤‡å¥½, é€šè¿‡socket, bindå’Œlistenè¿™ä¸‰ä¸ªå‡½æ•°,æˆ‘ä»¬æŠŠè¿™ä¸‰ä¸ªå‡½æ•°çš„
è¿‡ç¨‹å«:è¢«åŠ¨æ‰“å¼€(passive open)
</li>
<li>å®¢æˆ·ç«¯è‡ªç„¶å°±æ˜¯ä¸»åŠ¨æ‰“å¼€(active open) : å®¢æˆ·å‘é€ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„SYN segment,
é‡Œé¢åªæœ‰ä¸€ä¸ªåºåˆ—å·, å°±æ˜¯ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹ä»¥åå®¢æˆ·ç«¯å‘é€çš„ç¬¬ä¸€ä¸ªæ•°æ®çš„åºå·(å‡è®¾ä¸ºJ)
</li>
<li>æœåŠ¡å™¨å¿…é¡»ç¡®è®¤(ACK)åºå·ä¸ºJçš„SYN, åŒæ—¶å‘é€è‡ªå·±åœ¨è¿™æ¬¡æ¡æ‰‹åå‘é€çš„ç¬¬ä¸€ä¸ªæ•°æ®çš„
åºå·(å‡è®¾ä¸ºK), è¿™ä¸ªACKå’ŒSYNéƒ½æ˜¯åœ¨ä¸€ä¸ªsegmentä¸­å‘é€çš„
</li>
<li>å®¢æˆ·ç«¯è¦ç¡®è®¤æœåŠ¡å™¨çš„åºå·ä¸ºKçš„SYN
</li>
<li>å› ä¸º 2,3,4ä¸‰æ­¥ä¸­è¦æœ‰ä¸‰ä¸ªsegmentæ‰èƒ½å®Œæˆè¿æ¥çš„å»ºç«‹,æ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹å«åšä¸‰æ¬¡æ¡æ‰‹
</li>
</ol>
</li>
<li>ä¸‰æ¬¡æ¡æ‰‹å›¾è§£, æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ACKè¿”å›çš„æ˜¯J+1è¿™æ˜¯å› ä¸ºSYNæœ¬èº«ä¼šå ç”¨ä¸€ä¸ªåºåˆ—å·, Jæ˜¯å½“å‰
åºåˆ—å·,é‚£ä¹ˆç­‰è¿æ¥å»ºç«‹,ä¸‹æ¬¡å‘é€çš„å°±æ˜¯J+1äº†
<pre class="example">
               client                       server
   socket()      |      SYN(J)                |socket(), bind(), listen()
                 |                            |
connect() blocks +---------------------------&gt;|accept() blocks
                 |    SYN(K), ACK(J+1)      / |
connect() returns|&lt;-------------------------/ |
                 |\    ACK(K+1)               |
                 | \-------------------------&gt;|accept() returns
                 |                            |read() blocks
                 |                            |
</pre>
</li>
</ul>
</div>
<div id="outline-container-sec-2-6-1" class="outline-4">
<h4 id="sec-2-6-1">TCP Options</h4>
<div class="outline-text-4" id="text-2-6-1">
<ul class="org-ul">
<li>MSS: åœ¨ä¼ è¾“SYNçš„åŒæ—¶,å‘é€è‡ªå·±çš„æœ€å¤§segmentçš„å¤§å°(Maximum Segment Size)
</li>
<li>Windows scale: TCPå‘å¯¹æ–¹å±•ç¤ºçš„æœ€å¤§çª—å£æ•°ç›®ä¸º65535(ç›¸åº”çš„å¤´éƒ¨åªæœ‰16bit), ä½†æ˜¯
ç°åœ¨çš„ç½‘ç»œé€Ÿåº¦è¦è¿œè¿œå¤§äºè¿™ä¸ªæ•°ç›®, æ‰€ä»¥éœ€è¦ä¸€ä¸ªæ–°çš„å‚æ•°Windows scaleæ¥æˆå€æ‰©å±•
çª—å£å¤§å°. scaleæ˜¯0åˆ°14,è¡¨ç¤ºçª—å£æ•°ç›®å·¦ç§»å¤šå°‘ä½æœ€å¤§çª—å£æ•°ç›®ç°åœ¨æ˜¯1GB(65535*2^14)
</li>
<li>Windows scaleæ˜¯ä¸€ä¸ªæ–°çš„é€‰é¡¹,è€çš„TCPå®ç°ä¸æ”¯æŒ,æ‰€ä»¥åªæœ‰clientå‘é€äº†è¿™ä¸ªé€‰é¡¹,
å¹¶ä¸”å¯¹æ–¹serverå›åº”äº†è¿™ä¸ªé€‰é¡¹,æˆ‘ä»¬æ‰èƒ½ä½¿ç”¨. åŒæ ·çš„,serverç«¯åªæœ‰åœ¨clientå‘ç»™äº†
ä½ è¿™ä¸ªé€‰é¡¹,ä½ æ‰èƒ½å›åº”è¿™ä¸ªé€‰æ‹©.
</li>
<li>Timestamp: è¿™ä¸ªé€‰é¡¹å¯¹äºé«˜é€Ÿä¼ è¾“æ—¶å¯èƒ½äº§ç”Ÿçš„æ•°æ®ç ´åä¿®å¤(æ¯”å¦‚è¿Ÿåˆ°çš„segment,é‡å¤çš„
segment)å¾ˆæœ‰æ„ä¹‰.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-6-2" class="outline-4">
<h4 id="sec-2-6-2">TCP Connection Termination</h4>
<div class="outline-text-4" id="text-2-6-2">
<ul class="org-ul">
<li>å»ºç«‹ä¸€ä¸ªè¿æ¥éœ€è¦ä¸‰æ¬¡æ¡æ‰‹, ç»ˆæ­¢ä¸€ä¸ªè¿æ¥åˆ™éœ€è¦å››æ¬¡æŒ¥æ‰‹:
<ol class="org-ol">
<li>æŸä¸ªåº”ç”¨(æœåŠ¡å™¨ç«¯æˆ–è€…å®¢æˆ·ç«¯éƒ½å¯ä»¥, å…¨åŒå·¥å˜›,ä¸¤è¾¹éƒ½ä¸€æ ·)é¦–å…ˆè°ƒç”¨close, æˆ‘ä»¬ç§°ä¹‹ä¸º
ä¸»åŠ¨å…³é—­(active close). è¿™è¾¹çš„TCPä¸»åŠ¨å‘é€ä¸€ä¸ªFIN segment,è¡¨ç¤ºè‡ªå·±ä¼ å®Œäº†
</li>
<li>æ¥å—åˆ°FINçš„å¯¹ç«¯æ‰§è¡Œè¢«åŠ¨å…³é—­(passive close), è¿™ä¸ªFINä¼šè¢«TCPç¡®è®¤(å‘é€ä¸€ä¸ªACK)
åŒæ—¶è¿˜ä¼šæŠŠæ”¶åˆ°FINçš„æ¶ˆæ¯(åœ¨å½“å‰æ‰€æœ‰æ•°æ®ä¹‹å,åŠ ä¸ŠEOFçš„æ–¹å¼)ä¼ é€ç»™ä¸Šå±‚åº”ç”¨ç¨‹åº
</li>
<li>è¿‡äº†ä¸€æ®µæ—¶é—´ä»¥å,åˆšæ‰æ¥å—FINçš„ç«¯,ä¹Ÿæ²¡æœ‰å•¥ä¸œè¥¿å¯ä¼ äº†,å°±ä¼šå‘é€è‡ªå·±çš„FINç»™å¯¹æ–¹
</li>
<li>å¯¹æ–¹TCPæ¥å—åˆ°è¿™ä¸ªæœ€åçš„FINä¹‹å,ä¹Ÿä¼šå‘é€ä¸€ä¸ªACKç»™å¯¹æ–¹ç¡®è®¤çš„.
</li>
</ol>
</li>
<li>å››æ¬¡æŒ¥æ‰‹åªæ˜¯"æœ€å¤šå››æ¬¡", æœ‰äº›æƒ…å†µä¸‹ç”¨ä¸äº†å››æ¬¡:
<ul class="org-ul">
<li>ä¸Šé¢çš„1FINå¯èƒ½éšç€æ•°æ®ä¸€å—å‘è¿‡å»
</li>
<li>ä¸Šé¢çš„2ACK,3FINå¯èƒ½ä¼šåœ¨ä¸€ä¸ªsegmentå‘è¿‡æ¥
</li>
<li>ä¸Šé¢2å’Œ3ä¹‹é—´, è¢«åŠ¨å…³é—­çš„é‚£ä¸€ç«¯è¿˜æ˜¯å¯ä»¥ä¼ æ•°æ®ç»™ä¸»åŠ¨å…³é—­é‚£ä¸€ç«¯çš„,åªæ˜¯åè¿‡æ¥ä¸è¡Œäº†,
è¿™ä¸ªå«åšåŠå…³é—­(half close)
</li>
</ul>
</li>
<li>TCPå››æ¬¡æŒ¥æ‰‹å›¾è§£(close()å¯ä»¥é‡Šæ”¾FIN,åŒæ—¶exitæˆ–è€…éæ­£å¸¸ä¸­æ–­ä¹Ÿä¼šå‘é€)
<pre class="example">
               client                       server

                 |    FIN(M)                  |
      close()    +---------------------------&gt;|read() return 0 (eof)
                 |    ACK(M+1)              / |
connect() returns|&lt;-------------------------/ |
                           ........

                 |    FIN(N)                  |
                 |&lt;---------------------------+close()
                 |\    ACK(N+1)               |
                 | \-------------------------&gt;|
                 |                            |
                 |                            |
</pre>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-6-3" class="outline-4">
<h4 id="sec-2-6-3">TCP State Transitiion Diagram</h4>
<div class="outline-text-4" id="text-2-6-3">
<ul class="org-ul">
<li>å¦‚ä¸‹çš„ä¸ºTCPçš„çŠ¶æ€è½¬æ¢å›¾&#x2014;ä¸ºå®¢æˆ·ç«¯,===ä¸ºæœåŠ¡å™¨ç«¯
<pre class="example">
                                             starting point
                                             +------------+&lt;==========================================================+
                                             | CLOSED     |=====================================+                     |
                                             +-----+------+                 appl:active open    |                     ^
                                                   | appl:passive open      send:SYN            v                     |
                                                   v send:nothing                               |                     ^
         recv:SYN  send:SYN,ACK              +------------+                                     v                     |
       +-------------------------------------| LISTEN     |                                     |                     ^
       |  +=================================&gt;+------------+                                     |                     |
       v  | recv:RST                                                                            v                     ^
+------------+                             recv:SYN                                       +------------+ appl:close   |
| SYN_RECVD  |&lt;===========================================================================| SYN_SENT   |=============&gt;+
+------+-----+                             send:SYN, ACK                                  +-----+------+ or timeout   |
 send: | recv:ACK                       [[simultaneous open]]                 recv:SYN, ACK     |                     ^
nothing|                                                                     +==================+                     |
       |                                                                     | send:ACK                               ^
       |                                     +------------+&lt;=================+            +------------+              |
       +------------------------------------&gt;| ESTABLISHED|------------------------------&gt;| CLOSE_WAIT |              ^
                                             +------------+ recv:FIN send:ACK             +------------+              |
          appl:close send:FIN                      |                                            |appl:close           ^
       +===========================================+                                            |send:FIN             |
       |                                                                                        |                     ^
       v                                  [[simultaneous close]]                                v                     |
+------------+ recv:FIN send:ACK             +------------+                               +------------+ recv:ACK     ^
| FIN_WAIT_1 |==============================&gt;| CLOSING    |                               |LAST_ACK    |-------------&gt;+
+------+-----+==========+                    +-----+------+                               +------------+ send:nothing |
       |                |                          |                                                                  ^
       v recv ACK       |recv:FIN, ACK             | recv:ACK                                                         |
       | send nothing   |send:ACK                  | send:nothing                                                     ^
       v                |                          |                                                                  |
+------------+          +===================&gt;+-----+------+         2*MSL timeout                                     ^
| FIN_WAIT_2 |==============================&gt;| TIME_WAIT  |==========================================================&gt;+
+------------+ recv:FIN send:ACK             +------------+
</pre>
</li>
<li>ä¸Šé¢çš„å„ç§stateå°±æ˜¯netstatèƒ½å¤Ÿæ˜¾ç¤ºçš„çŠ¶æ€,å…¶ä¸­æœ‰ä¸¤ç§å¾ˆå°‘è§çš„æƒ…å†µæˆ‘ä»¬ä»æ²¡æœ‰è®¨è®ºè¿‡:
<ul class="org-ul">
<li>åŒæ—¶æ‰“å¼€(simulataneous open) : ä¸¤ç«¯å‡ ä¹åŒæ—¶å‘é€SYN
</li>
<li>åŒæ—¶å…³é—­(simulataneous close): ä¸¤ç«¯å‡ ä¹åŒæ—¶å‘é€FIN
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-6-4" class="outline-4">
<h4 id="sec-2-6-4">Watcing the Packets</h4>
<div class="outline-text-4" id="text-2-6-4">
<ul class="org-ul">
<li>æˆ‘ä»¬æŠŠå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½åœ¨ä¸€èµ·è€ƒè™‘,å°±ä¼šå¾—åˆ°ä¸‹é¢çš„å›¾ä¾‹
<pre class="example">
                    Client                               Server
      connect(blocks) | SYN(j), MSS=536                     | LISTEN(passive open), accept(blocks)
SYN_SENT(active open) +------------------------------------&gt;+ SYN_RCVD
                      |                                    /|
                      | SYN(K), ACK(J+1), MSS=1460        / |
    ESTABLISHED       +&lt;---------------------------------+  |
    connect returns   | \                                   |
                      |  \   ACK(K+1)                       |
                      |   +--------------------------------&gt;+ ESTABLISHED, accept returns, read (blocks)
                      |                                     |
                      |       data(request)                 |
              write   +------------------------------------&gt;+ read returns
        read(blocks)  |                                    [server process request]
                      |                                     |
                      |                                     +
                      |                                    /|write, read(blocks)
                      |    data(reply), ACK of request    / |
        read returns  +&lt;---------------------------------+  |
                      |\                                    |
                      | \  ACK of reply                     |
                      |  +---------------------------------&gt;+

                      |    FIN(M)                           |
   close   FIN_WAIT_1 +------------------------------------&gt;+ CLOSE_WAIT (passive close), read returns 0
                      |                                    /|
                      |    ACK(M+1)                       / |
           FIN_WAIT_2 +&lt;---------------------------------+  |
                      |                                     |
                      |    FIN(N)                           |
           TIME_WAIT  +&lt;------------------------------------+ close,LAST_ACK
                      |\                                    |
                      | \  ACK(N+1)                         |
                      |  +---------------------------------&gt;+ CLOSED
</pre>
</li>
<li>å®¢æˆ·ç«¯çš„MSSæ˜¯536,è€ŒæœåŠ¡å™¨æ˜¯1460, ä¸¤è¾¹çš„çª—å£ä¸ä¸€æ ·å¤§æ˜¯æ²¡é—®é¢˜çš„
</li>
<li>ä¸Šé¢ä¼ è¾“æ•°æ®çš„æ—¶å€™,æœåŠ¡å™¨çš„å¯¹å®¢æˆ·ç«¯æ•°æ®è¯·æ±‚çš„åº”ç­”,æ˜¯å’Œæ•°æ®ä¸€å—ä¼ ç»™å®¢æˆ·ç«¯çš„
,è¿™ä¸ªå«åšpiggybacking(æå¸¦åº”ç­”), è¿™ä¸ªæ˜¯å› ä¸ºserveråœ¨200msä»¥å†…å°±å¤„ç†äº†è¯·æ±‚,
æ‰€ä»¥ç¬¬ä¸€ä¸ªè¿”å›çš„segmenté‡Œé¢å°±ACKäº†request, å¦‚æœæ—¶é—´å¤ªä¹…,é‚£å°±ä¼šè®©segment
å…ˆèµ°,åœ¨åé¢çš„segmenté‡Œé¢æ¥ACK
</li>
<li>å‘èµ·ä¸»åŠ¨å…³é—­(active close)çš„ç«¯(è¿™é‡Œæ˜¯å®¢æˆ·ç«¯)æœ€åè¿›å…¥äº†TIME_WAIT,å› ä¸ºå®ƒè¦
ä¿è¯æœ€åä¸€ä¸ªACK(N+1)ä¸¢å¤±äº†èƒ½å¤Ÿé‡å‘,æ‰€ä»¥è¦ç­‰å¾…2MSçš„æ—¶é—´
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-2-7" class="outline-3">
<h3 id="sec-2-7">TIME_WAIT State</h3>
<div class="outline-text-3" id="text-2-7">
<ul class="org-ul">
<li>åœ¨ä¸Šå›¾ä¸­æœ€ä»¤äººè¿·æƒ‘çš„çŠ¶æ€å°±æ˜¯TIME_WAIT, å®ƒè¦ç»è¿‡ä¸¤å€çš„MSL(maximum segment
lifetime)çš„æ—¶é—´æ‰èƒ½è½¬æˆå…³é—­çŠ¶æ€
</li>
<li>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹MSL,ä»–æ˜¯ä¸€ä¸ªipæ•°æ®æŠ¥èƒ½å¤Ÿåœ¨ç½‘ç»œä¸Šå­˜æ´»çš„æ—¶é—´,ipæ•°æ®æŠ¥æœ‰ä¸€ä¸ªè·³è·ƒ
æé™(hop limit): hopå­—æ®µçš„é•¿åº¦ä¸º255bit,ä¹Ÿå°±æ˜¯è¯´ipåœ¨è·¯ç”±å™¨é—´ä¼ é€’è¶…è¿‡255æ¬¡
å°±è‡ªåŠ¨è¢«ä¸¢å¼ƒäº†(æœ‰å¯èƒ½æœ‰å¾ªç¯äº§ç”Ÿ).
</li>
<li>æ ¹æ®å‰é¢çš„èƒŒæ™¯çŸ¥è¯†,æˆ‘ä»¬è‡³å°‘æœ‰ä¸¤ä¸ªç†ç”±æ¥ç»´æŒä¸¤å€çš„MSL:
<ol class="org-ol">
<li>å‡è®¾æˆ‘ä»¬åœ¨12.106.32.254:1500 å’Œ206.168.112.219:21ä¹‹é—´å»ºç«‹äº†ä¸€ä¸ªTCP
è¿æ¥,ä¹‹åå…³é—­å®ƒ. è¿‡ä¸€æ®µæ—¶é—´å,æˆ‘ä»¬ç”¨åŒæ ·çš„IPå’Œç«¯å£å¯¹å†å»ºç«‹ä¸€æ¬¡è¿æ¥, å
ä¸€ä¸ªè¿æ¥ç§°ä¹‹ä¸ºå‰ä¸€ä¸ªè¿æ¥çš„åŒ–èº«(incarnation), TCPå¿…é¡»é¿å…æ–°çš„è¿æ¥å—åˆ°è€
çš„è¿æ¥é‡å¤åˆ†ç»„(lost duplicate, ä¹Ÿå°±æ˜¯è¶…æ—¶é‡ä¼ å,ä¸¢å¤±çš„åˆé€šè¿‡è·¯ç”±ä¿®å¤
ä¼ å›æ¥äº†)çš„å¹²æ‰°,æˆ‘ä»¬è®¾ç½®äº†ä¸¤å€MSL,ä¿è¯è€çš„é‡å¤åˆ†ç»„å·²ç»åœ¨ç½‘ç»œä¸Šä¸¢å¼ƒäº†
</li>
<li>æˆ‘ä»¬ä¸Šä¸€èŠ‚è¯´é“äº†ä¸»åŠ¨closeçš„å®¢æˆ·ç«¯ä¼šä¿ç•™TIME_WAITé•¿è¾¾2MSçš„æ—¶é—´,å› ä¸ºå¦‚æœ
æœ€åä¸€ä¸ªACK(N+1)ä¸¢å¤±äº†çš„è¯,serverç«¯è¶…å¸‚ä¼šé‡å‘FIN(N), å®¢æˆ·ç«¯è¦ä¿è¯è‡ªå·±
è¿˜åœ¨è¿™ä¸ªconnection, ç„¶åé‡æ–°å‘é€ACK(N+1)
</li>
</ol>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

         <!-- Duoshuo Comment BEGIN -->
         <div class="ds-thread"></div>
         <script type="text/javascript">
             var duoshuoQuery = {short_name:"harrifeng"};
             (function() {
             var ds = document.createElement('script');
             ds.type = 'text/javascript';ds.async = true;
             ds.src = 'http://static.duoshuo.com/embed.js';
             ds.charset = 'UTF-8';
             (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
             })();
         </script>
         <!-- Duoshuo Comment END -->
</div>
</body>
</html>
